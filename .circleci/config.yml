version: 2.1

orbs:
  node: circleci/node@2.0.3

commands:
  setup:
    steps:
      - checkout
      - node/install:
          node-version: 12.16.3
          install-yarn: true
      - run:
          name: Versions
          command: |
            node -v
            npm -v
            yarn -v
            pwd
            echo $CIRCLE_WORKING_DIRECTORY
      - node/install-packages:
          app-dir: $CIRCLE_WORKING_DIRECTORY
          pkg-manager: yarn
          cache-key: yarn.lock
      - run:
          name: Move project dir
          command: |
            pwd
            ls
jobs:
  prod-deploy:
    working_directory: ~/ctodo
    executor:
      name: node/default
      tag: 12.16.3
    steps:
      - setup
      - run:
          name: deploy to now
          command: |
            yarn deploy
  stg-deploy:
    working_directory: ~/stg-ctodo
    executor:
      name: node/default
      tag: 12.16.3
    steps:
      - setup
      - run:
          name: deploy to now
          command: |
            yarn deploy

workflows:
  version: 2
  deploy:
    jobs:
      - stg-deploy
      - prod-deploy:
          filters:
            branches:
              only:
                - master
